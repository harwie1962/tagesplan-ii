<!-- index.html -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tagesplan Erinnerungen - 1500 kcal</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(1000px 700px at 80% 15%, rgba(167,139,250,.16), transparent 60%),
        radial-gradient(900px 650px at 50% 90%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(135deg,#0b1220 0%, #101a33 45%, #0b1326 100%);
      min-height:100vh;
      padding:20px;
      color:#eaf0ff;
      transition:background .5s ease;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body.medical{
      background:linear-gradient(135deg,#e8f5e9 0%,#c8e6c9 100%);
      color:#102014;
    }

    .container{
      max-width:820px;
      margin:0 auto;
      background:rgba(255,255,255,.95);
      border-radius:22px;
      box-shadow:0 14px 40px rgba(0,0,0,.28);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    body.medical .container{
      background:#fff;
      border:0;
      box-shadow:0 20px 60px rgba(0,0,0,.30);
    }

    .header{
      background:
        linear-gradient(135deg, rgba(11,18,32,.92) 0%, rgba(16,26,51,.92) 60%, rgba(11,19,38,.92) 100%),
        radial-gradient(900px 260px at 15% 0%, rgba(110,231,255,.25), transparent 60%),
        radial-gradient(900px 260px at 85% 0%, rgba(167,139,250,.22), transparent 60%);
      color:#fff;
      padding:28px 28px 22px;
      text-align:center;
      transition:background .5s ease;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    body.medical .header{
      background:linear-gradient(135deg,#2e7d32 0%,#1b5e20 100%);
      border-bottom:0;
    }

    .header h1{
      font-size:26px;
      margin-bottom:10px;
      letter-spacing:.2px;
    }

    .current-time{
      font-size:46px;
      font-weight:800;
      margin:18px 0 12px;
      text-shadow:2px 2px 8px rgba(0,0,0,.35);
    }

    .status{
      font-size:15px;
      padding:10px 16px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      border-radius:12px;
      display:inline-block;
    }

    .day-switch{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:12px;
    }
    .day-btn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.10);
      color:#fff;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      transition:transform .15s ease, background .15s ease;
      user-select:none;
    }
    .day-btn:hover{ transform:translateY(-1px); background:rgba(255,255,255,.16); }
    .day-btn.active{
      background:rgba(255,255,255,.28);
      border-color:rgba(255,255,255,.45);
    }
    body.medical .day-btn{
      background:rgba(255,255,255,.70);
      color:#102014;
      border:1px solid rgba(16,32,20,.18);
    }
    body.medical .day-btn.active{
      background:rgba(255,255,255,.95);
      border-color:rgba(16,32,20,.25);
    }

    .sound-toggle{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      border-radius:12px;
      margin-top:12px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .sound-toggle input{ width:20px; height:20px; cursor:pointer; }

    .content{ padding:26px; color:#0e172a; }
    body.medical .content{ color:#0e1b12; }

    .next-item{
      background:
        linear-gradient(135deg, rgba(15,23,42,.96) 0%, rgba(30,41,59,.96) 100%),
        radial-gradient(700px 220px at 15% 10%, rgba(110,231,255,.25), transparent 60%),
        radial-gradient(700px 220px at 85% 10%, rgba(167,139,250,.22), transparent 60%);
      color:#fff;
      padding:22px;
      border-radius:16px;
      margin-bottom:26px;
      box-shadow:0 14px 36px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
    }
    body.medical .next-item{
      background:linear-gradient(135deg,#4caf50 0%,#388e3c 100%);
      box-shadow:0 10px 30px rgba(76,175,80,.3);
      border:0;
    }

    .next-item h2{ font-size:18px; margin-bottom:12px; display:flex; align-items:center; gap:10px; letter-spacing:.2px; }
    .next-item h2::before{ content:"‚è∞"; font-size:22px; }
    .next-item .time{ font-size:30px; font-weight:800; margin-bottom:8px; letter-spacing:.3px; }
    .next-item .description{ font-size:15px; line-height:1.6; opacity:.96; }

    .timeline{ position:relative; padding-left:38px; }
    .timeline::before{
      content:"";
      position:absolute;
      left:14px;
      top:0;
      bottom:0;
      width:3px;
      background:linear-gradient(180deg, rgba(110,231,255,.85) 0%, rgba(167,139,250,.85) 55%, rgba(34,197,94,.65) 100%);
      border-radius:3px;
    }
    body.medical .timeline::before{
      background:linear-gradient(180deg,#66bb6a 0%,#388e3c 100%);
    }

    .timeline-item{
      position:relative;
      padding:14px 14px 12px;
      margin-bottom:12px;
      background:#f6f7fb;
      border:1px solid rgba(15,23,42,.08);
      border-radius:12px;
      transition:background .2s ease;
    }
    .timeline-item::before{
      content:"";
      position:absolute;
      left:-31px;
      top:18px;
      width:14px;
      height:14px;
      border-radius:50%;
      background:#fff;
      border:3px solid rgba(110,231,255,.9);
      box-shadow:0 2px 8px rgba(0,0,0,.12);
    }
    body.medical .timeline-item::before{ border-color:#4caf50; }

    .timeline-item.completed{ opacity:.55; background:#eef0f6; }
    .timeline-item.completed::before{ background:#22c55e; border-color:#22c55e; }

    .timeline-item.current{
      background:linear-gradient(135deg,#e8f1ff 0%, #f3e8ff 70%, #e8fff1 100%);
      box-shadow:0 10px 22px rgba(2,6,23,.12);
      border-color:rgba(110,231,255,.35);
    }
    body.medical .timeline-item.current{
      background:linear-gradient(135deg,#c8e6c9 0%,#a5d6a7 100%);
      box-shadow:0 5px 15px rgba(165,214,167,.4);
      border-color:transparent;
    }
    .timeline-item.current::before{
      background:rgba(110,231,255,.95);
      border-color:rgba(110,231,255,.95);
      animation:pulse 2s infinite;
    }
    body.medical .timeline-item.current::before{
      background:#2e7d32;
      border-color:#2e7d32;
    }
    @keyframes pulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.3)} }

    .timeline-item .time{ font-weight:800; color:#0b1220; font-size:16px; margin-bottom:6px; }
    body.medical .timeline-item .time{ color:#1b5e20; }
    .timeline-item .description{ color:#111827; font-size:13.5px; line-height:1.5; }
    body.medical .timeline-item .description{ color:#102014; }
    .timeline-item .calories{ color:#2563eb; font-weight:800; margin-top:6px; font-size:12.5px; }
    body.medical .timeline-item .calories{ color:#1b5e20; }

    .controls{ display:flex; gap:10px; margin-bottom:18px; flex-wrap:wrap; }

    .btn{
      padding:12px 18px;
      border:none;
      border-radius:12px;
      font-size:15px;
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
      font-weight:800;
      letter-spacing:.1px;
    }
    .btn-primary{
      background:linear-gradient(135deg,#0ea5e9 0%, #8b5cf6 55%, #22c55e 110%);
      color:#fff;
      box-shadow:0 10px 24px rgba(2,6,23,.18);
    }
    body.medical .btn-primary{
      background:linear-gradient(135deg,#4caf50 0%,#388e3c 100%);
      box-shadow:none;
    }
    .btn-secondary{
      background:#eef2f7;
      color:#0b1220;
      border:1px solid rgba(15,23,42,.10);
    }
    .btn-secondary:hover{ background:#e6ebf3; transform:translateY(-1px); }

    .notification-permission{
      background:#fff3cd;
      border:2px solid #ffc107;
      padding:14px;
      border-radius:12px;
      margin-bottom:16px;
      display:none;
      color:#1f2937;
    }
    .notification-permission.show{ display:block; }

    .panel{
      background:#f3f4f6;
      border:2px dashed rgba(0,0,0,.14);
      padding:14px;
      border-radius:14px;
      margin-bottom:16px;
      color:#111827;
    }
    .panel h3{ margin-bottom:10px; color:#0b1220; font-size:15px; }
    body.medical .panel{ background:#fff; }
    body.medical .panel h3{ color:#1b5e20; }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .row:first-of-type{ margin-top:0; }
    .row label{ font-weight:800; color:#0b1220; }
    body.medical .row label{ color:#1b5e20; }
    .row input[type="time"]{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #ced4da;
      font-size:15px;
      background:#fff;
    }
    .row input[type="checkbox"]{ width:18px; height:18px; cursor:pointer; }

    .hint{ margin-top:10px; font-size:12.5px; color:#374151; line-height:1.45; }
    .hint code{ background:rgba(0,0,0,.06); padding:2px 6px; border-radius:8px; }

    .small-pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.08);
      font-weight:800;
      font-size:13px;
    }

    .calorie-summary{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:0 0 18px;
    }
    .calorie-pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:12px;
      background:linear-gradient(135deg,#0ea5e9 0%, #8b5cf6 55%, #22c55e 110%);
      color:#fff;
      font-weight:800;
      box-shadow:0 10px 24px rgba(2,6,23,.18);
    }
    body.medical .calorie-pill{
      background:linear-gradient(135deg,#4caf50 0%,#388e3c 100%);
      box-shadow:none;
    }
    .calorie-label{ opacity:.85; font-weight:700; letter-spacing:.2px; }
    .calorie-value{ font-size:16px; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üçΩÔ∏è Dein Tagesplan</h1>
      <div class="current-time" id="currentTime">00:00:00</div>
      <div class="status" id="status">L√§dt...</div>

      <div class="day-switch" id="daySwitch">
        <button class="day-btn" data-day="auto">AUTO</button>
        <button class="day-btn" data-day="mon">MO</button>
        <button class="day-btn" data-day="tue">DI</button>
        <button class="day-btn" data-day="wed">MI</button>
        <button class="day-btn" data-day="thu">DO</button>
        <button class="day-btn" data-day="fri">FR</button>
        <button class="day-btn" data-day="sat">SA</button>
        <button class="day-btn" data-day="sun">SO</button>
      </div>

      <div class="sound-toggle">
        <input type="checkbox" id="soundToggle" checked onchange="toggleSound()" />
        <label for="soundToggle" style="cursor:pointer;">üîä Signalton aktiviert</label>
      </div>
    </div>

    <div class="content">
      <div class="notification-permission" id="notificationAlert">
        <strong>‚ö†Ô∏è Benachrichtigungen aktivieren?</strong><br />
        Damit du rechtzeitig erinnert wirst, erlaube bitte die Browser-Benachrichtigungen.
        <button class="btn btn-primary" onclick="requestNotificationPermission()" style="margin-top:10px;">
          Benachrichtigungen aktivieren
        </button>
      </div>

      <div class="panel">
        <h3>‚è±Ô∏è Verschlafen-Modus (Zeitversatz)</h3>

        <div class="row">
          <label for="anchorTime">Ich bin aufgestanden um</label>
          <input type="time" id="anchorTime" />
          <button class="btn btn-primary" onclick="applyOffsetFromAnchor()">Offset setzen</button>
          <button class="btn btn-secondary" onclick="resetOffset()">Offset zur√ºcksetzen</button>
        </div>

        <div class="row">
          <input type="checkbox" id="applyAllDay" onchange="toggleApplyAllDay()" />
          <label for="applyAllDay" style="cursor:pointer;">
            Offset auf <strong>alle</strong> Zeiten anwenden (sonst nur morgens bis 12:00)
          </label>
        </div>

        <div class="row" style="align-items:center;">
          <span class="small-pill" title="Verschiebt Termine AB 12:00 (Mittag + alles danach)">
            üåô Nachmittag (ab 12:00): <span id="afternoonLabel">0 min</span>
          </span>
          <button class="btn btn-primary" onclick="shiftAfternoon(-15)">‚àí15</button>
          <button class="btn btn-primary" onclick="shiftAfternoon(+15)">+15</button>
          <button class="btn btn-secondary" onclick="resetAfternoonShift()">Reset</button>
        </div>

        <div class="hint">
          <div>‚Ä¢ Standard: Morgen-Offset wirkt nur auf Zeiten <code>vor 12:00</code>.</div>
          <div>‚Ä¢ Haken an: Morgen-Offset wirkt auf <code>alle</code> Zeiten.</div>
          <div>‚Ä¢ Zus√§tzlich kannst du <strong>ab 12:00</strong> alles nach vorn/hinten schieben (‚àí15 / +15).</div>
          <div>‚Ä¢ Speichert automatisch im Browser (localStorage).</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="toggleTheme()">üé® Design wechseln</button>
        <button class="btn btn-primary" onclick="testNotification()">üîî Test-Benachrichtigung</button>
        <button class="btn btn-secondary" onclick="scrollToNext()">‚¨áÔ∏è Zum n√§chsten Punkt</button>
      </div>

      <div id="nextItem"></div>
      <div class="calorie-summary" id="calorieSummary"></div>

      <h3 style="margin-bottom:18px;color:#111827;">üìã Tages√ºbersicht</h3>
      <div class="timeline" id="timeline"></div>
    </div>
  </div>

  <!-- Sound ist ausgelagert -->
  <script src="sound.js"></script>

  <script>
    // =========================================================
    // 1) Plan-Laden (GitHub Pages): plans/mon.js ... plans/sun.js
    // =========================================================

    let schedule = [];

    const DAY_MAP = ["sun","mon","tue","wed","thu","fri","sat"];
    const DAY_OVERRIDE_KEY = "scheduleDayOverride"; // "auto" oder "mon".."sun"
    const MANUAL_UNTIL_KEY = "scheduleManualUntilTs";

    function getTodayKey(){
      return DAY_MAP[new Date().getDay()];
    }

    function getSelectedDayKey(){
      // 1) URL override: ?day=mon
      const params = new URLSearchParams(window.location.search);
      const q = (params.get("day") || "").toLowerCase();
      if (DAY_MAP.includes(q)) return q;

      // 2) localStorage override
      const saved = (localStorage.getItem(DAY_OVERRIDE_KEY) || "auto").toLowerCase();
      if (saved === "auto") return getTodayKey();
      if (DAY_MAP.includes(saved)) return saved;

      return getTodayKey();
    }

    function getPlanFileForDay(dayKey){
      return `plans/${dayKey}.js`;
    }

    function loadScheduleScript(src){
      return new Promise((resolve, reject) => {
        const old = document.getElementById("planScript");
        if (old) old.remove();

        const s = document.createElement("script");
        s.id = "planScript";
        s.src = src + "?v=" + Date.now();
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Konnte Plan-Datei nicht laden: " + src));
        document.head.appendChild(s);
      });
    }

    async function loadPlanForCurrentSelection(){
      const dayKey = getSelectedDayKey();
      const file = getPlanFileForDay(dayKey);

      await loadScheduleScript(file);

      if (Array.isArray(window.schedule) && window.schedule.length){
        schedule = window.schedule;
      } else {
        throw new Error("Plan-Datei geladen, aber window.schedule ist leer oder fehlt.");
      }

      setStatusPlanInfo();
      updateTimeline();
      updateNextItem();
      updateCalorieSummary();
    }

    function setStatusPlanInfo(){
      const saved = (localStorage.getItem(DAY_OVERRIDE_KEY) || "auto").toLowerCase();
      const effective = getSelectedDayKey();
      const label = (saved === "auto" ? `AUTO (${effective.toUpperCase()})` : saved.toUpperCase());
      const status = document.getElementById("status");
      if (status) status.textContent = `Plan: ${label}`;
    }

    function initDaySwitch(){
      const wrap = document.getElementById("daySwitch");
      if (!wrap) return;

      const btns = Array.from(wrap.querySelectorAll(".day-btn"));

      const setActiveButtons = () => {
        const saved = (localStorage.getItem(DAY_OVERRIDE_KEY) || "auto").toLowerCase();
        btns.forEach(b => b.classList.remove("active"));
        const activeKey = (saved === "auto") ? "auto" : saved;
        const el = wrap.querySelector(`.day-btn[data-day="${activeKey}"]`);
        if (el) el.classList.add("active");
      };

      btns.forEach(btn => {
        if (btn.dataset.bound === "1") return;
        btn.dataset.bound = "1";

        btn.addEventListener("click", async () => {
          const key = (btn.getAttribute("data-day") || "auto").toLowerCase();

          if (key === "auto"){
            localStorage.setItem(DAY_OVERRIDE_KEY, "auto");
            localStorage.removeItem(MANUAL_UNTIL_KEY);
          } else {
            localStorage.setItem(DAY_OVERRIDE_KEY, key);
            // Auto stellt sich nach 1 Minute wieder ein
            localStorage.setItem(MANUAL_UNTIL_KEY, String(Date.now() + 60000));
          }

          setActiveButtons();

          try{
            await loadPlanForCurrentSelection();
          } catch(e){
            showPlanError(e);
          }
        });
      });

      setActiveButtons();
    }

    function showPlanError(e){
      console.error(e);
      const status = document.getElementById("status");
      if (status) status.textContent = "Plan-Datei fehlt/Fehler";

      const nextItemDiv = document.getElementById("nextItem");
      if (nextItemDiv){
        nextItemDiv.innerHTML = `
          <div class="next-item">
            <h2>‚ö†Ô∏è Plan konnte nicht geladen werden</h2>
            <div class="description">${String(e && (e.message || e) || "Unbekannter Fehler")}</div>
          </div>
        `;
      }

      const timeline = document.getElementById("timeline");
      if (timeline) timeline.innerHTML = "";
    }

    // =========================================================
    // 2) Offset-Logik (Morgen-Offset + Nachmittag-Shift ab 12:00)
    // =========================================================
    const PLAN_START = "06:15";
    const MORNING_CUTOFF = "12:00";

    const OFFSET_KEY = "scheduleOffsetMin";
    const ANCHOR_KEY = "scheduleAnchorTime";
    const APPLY_ALL_KEY = "scheduleOffsetApplyAllDay";
    const AFTERNOON_KEY = "scheduleAfternoonOffsetMin";

    let offsetMinutes = 0;
    let afternoonOffsetMinutes = 0;
    let applyAllDay = false;

    let lastNotifiedIndex = -1;
    let soundEnabled = true;

    function getTimeInMinutes(timeStr){
      const [h,m] = timeStr.split(":").map(Number);
      return h*60 + m;
    }

    function minutesToHHMM(totalMinutes){
      const mod = ((totalMinutes % 1440) + 1440) % 1440;
      const h = String(Math.floor(mod/60)).padStart(2,"0");
      const m = String(mod%60).padStart(2,"0");
      return `${h}:${m}`;
    }

    function getCurrentMinutes(){
      const now = new Date();
      return now.getHours()*60 + now.getMinutes();
    }

    function getPerItemOffset(item){
      const baseMin = getTimeInMinutes(item.time);
      const cutoffMin = getTimeInMinutes(MORNING_CUTOFF);

      let off = 0;

      // Morgen-Offset: (Haken an => alles, Haken aus => nur vor 12:00)
      if (applyAllDay || baseMin < cutoffMin) {
        off += offsetMinutes;
      }

      // Nachmittag-Shift: ab 12:00 zus√§tzlich
      if (baseMin >= cutoffMin) {
        off += afternoonOffsetMinutes;
      }

      return off;
    }

    function getEffectiveItemMinutes(item){
      const perOffset = getPerItemOffset(item);
      return ((getTimeInMinutes(item.time) + perOffset) % 1440 + 1440) % 1440;
    }

    function getEffectiveItemTimeStr(item){
      const perOffset = getPerItemOffset(item);
      return minutesToHHMM(getTimeInMinutes(item.time) + perOffset);
    }

    function saveOffset(mins, anchorTimeStr){
      offsetMinutes = mins;
      localStorage.setItem(OFFSET_KEY, String(mins));
      if (anchorTimeStr) localStorage.setItem(ANCHOR_KEY, anchorTimeStr);
    }

    function saveAfternoonOffset(mins){
      afternoonOffsetMinutes = mins;
      localStorage.setItem(AFTERNOON_KEY, String(mins));
      updateAfternoonLabel();
    }

    function updateAfternoonLabel(){
      const el = document.getElementById("afternoonLabel");
      if (!el) return;
      const v = afternoonOffsetMinutes || 0;
      el.textContent = (v >= 0 ? `+${v}` : `${v}`) + " min";
    }

    function saveApplyAllDay(value){
      applyAllDay = !!value;
      localStorage.setItem(APPLY_ALL_KEY, applyAllDay ? "true" : "false");
    }

    function loadOffset(){
      const saved = localStorage.getItem(OFFSET_KEY);
      offsetMinutes = saved !== null ? (parseInt(saved,10) || 0) : 0;

      const savedAfternoon = localStorage.getItem(AFTERNOON_KEY);
      afternoonOffsetMinutes = savedAfternoon !== null ? (parseInt(savedAfternoon,10) || 0) : 0;

      const anchor = localStorage.getItem(ANCHOR_KEY);
      const anchorInput = document.getElementById("anchorTime");
      if (anchor && anchorInput) anchorInput.value = anchor;

      const savedApplyAll = localStorage.getItem(APPLY_ALL_KEY);
      applyAllDay = savedApplyAll === "true";
      const applyAllEl = document.getElementById("applyAllDay");
      if (applyAllEl) applyAllEl.checked = applyAllDay;

      updateAfternoonLabel();
    }

    function toggleApplyAllDay(){
      const el = document.getElementById("applyAllDay");
      saveApplyAllDay(el && el.checked);
      lastNotifiedIndex = -1;
      updateTimeline();
      updateNextItem();
      updateCalorieSummary();
    }

    function applyOffsetFromAnchor(){
      const anchorInput = document.getElementById("anchorTime");
      if (!anchorInput || !anchorInput.value) return;

      const actualStart = getTimeInMinutes(anchorInput.value);
      const planStart = getTimeInMinutes(PLAN_START);

      const mins = actualStart - planStart;
      saveOffset(mins, anchorInput.value);

      lastNotifiedIndex = -1;
      updateTimeline();
      updateNextItem();
      updateCalorieSummary();
    }

    function resetOffset(){
      saveOffset(0, "");
      localStorage.removeItem(ANCHOR_KEY);

      const anchorInput = document.getElementById("anchorTime");
      if (anchorInput) anchorInput.value = "";

      lastNotifiedIndex = -1;
      updateTimeline();
      updateNextItem();
      updateCalorieSummary();
    }

    function shiftAfternoon(delta){
      saveAfternoonOffset((afternoonOffsetMinutes || 0) + delta);
      lastNotifiedIndex = -1;
      updateTimeline();
      updateNextItem();
      updateCalorieSummary();
    }

    function resetAfternoonShift(){
      saveAfternoonOffset(0);
      lastNotifiedIndex = -1;
      updateTimeline();
      updateNextItem();
      updateCalorieSummary();
    }

    // =========================================================
    // 3) Anzeige-Logik (Timeline / Next)
    // =========================================================
    function updateTime(){
      const now = new Date();
      const el = document.getElementById("currentTime");
      if (el) el.textContent = now.toLocaleTimeString("de-DE");
    }

    function findCurrentAndNext(){
      const currentMinutes = getCurrentMinutes();

      const indexed = schedule.map((item, index) => ({
        item, index,
        eff: getEffectiveItemMinutes(item)
      }));

      indexed.sort((a,b) => a.eff - b.eff);

      const next = indexed.find(x => x.eff > currentMinutes);
      const nextIndex = next ? next.index : -1;

      let currentSortedPos = -1;
      for (let i=0;i<indexed.length;i++){
        if (indexed[i].eff <= currentMinutes) currentSortedPos = i;
      }
      const currentIndex = currentSortedPos >= 0 ? indexed[currentSortedPos].index : -1;

      return { currentIndex, nextIndex, sorted:indexed };
    }

    function updateTimeline(){
      const timeline = document.getElementById("timeline");
      if (!timeline) return;

      if (!Array.isArray(schedule) || !schedule.length){
        timeline.innerHTML = "";
        return;
      }

      const { currentIndex, sorted } = findCurrentAndNext();
      timeline.innerHTML = "";

      sorted.forEach(({ item, index }) => {
        const div = document.createElement("div");
        div.className = "timeline-item";
        div.id = `item-${index}`;

        const currentPos = sorted.findIndex(x => x.index === currentIndex);
        const thisPos = sorted.findIndex(x => x.index === index);

        if (currentIndex !== -1 && thisPos < currentPos) div.classList.add("completed");
        if (index === currentIndex) div.classList.add("current");

        const effTime = getEffectiveItemTimeStr(item);

        div.innerHTML = `
          <div class="time">${effTime} Uhr</div>
          <div class="description">
            <strong>${item.title}</strong>
            ${item.description ? `<br>${item.description}` : ""}
          </div>
          ${item.calories > 0 ? `<div class="calories">üìä ${item.calories} kcal</div>` : ""}
        `;
        timeline.appendChild(div);
      });
    }

    function updateNextItem(){
      const nextItemDiv = document.getElementById("nextItem");
      if (!nextItemDiv) return;

      if (!Array.isArray(schedule) || !schedule.length){
        nextItemDiv.innerHTML = `
          <div class="next-item">
            <h2>‚ö†Ô∏è Kein Plan geladen</h2>
            <div class="description">Bitte pr√ºfe deine Plan-Dateien in <code>plans/</code>.</div>
          </div>
        `;
        return;
      }

      const { nextIndex } = findCurrentAndNext();

      if (nextIndex === -1){
        nextItemDiv.innerHTML = `
          <div class="next-item">
            <h2>‚úÖ Tagesplan abgeschlossen!</h2>
            <div class="description">Alle Punkte f√ºr heute erledigt.</div>
          </div>
        `;
        return;
      }

      const nextItem = schedule[nextIndex];
      const currentMinutes = getCurrentMinutes();
      const nextMinutes = getEffectiveItemMinutes(nextItem);

      let minutesUntil = nextMinutes - currentMinutes;
      if (minutesUntil < 0) minutesUntil += 1440;

      const effTime = getEffectiveItemTimeStr(nextItem);

      nextItemDiv.innerHTML = `
        <div class="next-item">
          <h2>Als N√§chstes:</h2>
          <div class="time">${effTime} Uhr</div>
          <div class="description">
            <strong>${nextItem.title}</strong><br>
            ${nextItem.description ? `${nextItem.description}<br>` : ""}
            ${nextItem.calories > 0 ? `<br>üìä ${nextItem.calories} kcal` : ""}
          </div>
        </div>
      `;
    }

    function calculateCalorieTotals(){
      if (!Array.isArray(schedule) || !schedule.length) return null;

      const total = schedule.reduce((sum, item) => sum + (parseInt(item.calories, 10) || 0), 0);
      const currentMinutes = getCurrentMinutes();

      const sorted = schedule
        .map(item => ({ item, eff: getEffectiveItemMinutes(item) }))
        .sort((a, b) => a.eff - b.eff);

      const completed = sorted.reduce((sum, entry) => {
        const kcal = parseInt(entry.item.calories, 10) || 0;
        return entry.eff <= currentMinutes ? sum + kcal : sum;
      }, 0);

      const remaining = Math.max(total - completed, 0);
      return { total, completed, remaining };
    }

    function updateCalorieSummary(){
      const summary = document.getElementById("calorieSummary");
      if (!summary) return;

      if (!Array.isArray(schedule) || !schedule.length){
        summary.innerHTML = "";
        return;
      }

      const totals = calculateCalorieTotals();
      if (!totals){
        summary.innerHTML = "";
        return;
      }

      summary.innerHTML = `
        <div class="calorie-pill">
          <span class="calorie-label">Gesamt</span>
          <span class="calorie-value">${totals.total} kcal</span>
        </div>
        <div class="calorie-pill">
          <span class="calorie-label">Erledigt</span>
          <span class="calorie-value">${totals.completed} kcal</span>
        </div>
        <div class="calorie-pill">
          <span class="calorie-label">Offen</span>
          <span class="calorie-value">${totals.remaining} kcal</span>
        </div>
      `;
    }

    // =========================================================
    // 4) Notifications / Sound / Theme / Scroll
    // =========================================================
    function checkForNotifications(){
      if (!("Notification" in window)) return;
      if (Notification.permission !== "granted") return;
      if (!Array.isArray(schedule) || !schedule.length) return;

      const { nextIndex } = findCurrentAndNext();
      if (nextIndex === -1 || nextIndex === lastNotifiedIndex) return;

      const nextItem = schedule[nextIndex];
      const currentMinutes = getCurrentMinutes();
      const nextMinutes = getEffectiveItemMinutes(nextItem);

      let minutesUntil = nextMinutes - currentMinutes;
      if (minutesUntil < -720) minutesUntil += 1440;
      if (minutesUntil < 0) minutesUntil += 1440;

      if (minutesUntil <= 2){
        sendNotification(nextItem);
        lastNotifiedIndex = nextIndex;
      }
    }

    function sendNotification(item){
      if (soundEnabled && window.Sound) window.Sound.play();
      const effTime = getEffectiveItemTimeStr(item);

      const n = new Notification("üçΩÔ∏è Tagesplan Erinnerung", {
        body: `${effTime} Uhr: ${item.title}${item.description ? "\n" + item.description : ""}`,
        tag: "meal-reminder",
        requireInteraction: true
      });

      n.onclick = function(){
        window.focus();
        n.close();
      };
    }

    function requestNotificationPermission(){
      if (!("Notification" in window)) return;
      Notification.requestPermission().then(permission => {
        if (permission === "granted"){
          const a = document.getElementById("notificationAlert");
          if (a) a.classList.remove("show");
          alert("‚úÖ Benachrichtigungen aktiviert!");
        }
      });
    }

    function testNotification(){
      if (!("Notification" in window)) return;

      if (Notification.permission === "granted"){
        if (soundEnabled && window.Sound) window.Sound.play();
        new Notification("üçΩÔ∏è Test-Benachrichtigung", { body: "Die Benachrichtigungen funktionieren!" });
      } else if (Notification.permission === "denied"){
        alert("Benachrichtigungen wurden blockiert. Bitte aktiviere sie in den Browser-Einstellungen.");
      } else {
        requestNotificationPermission();
      }
    }

    function toggleSound(){
      const el = document.getElementById("soundToggle");
      soundEnabled = !!(el && el.checked);
      localStorage.setItem("soundEnabled", String(soundEnabled));
      if (window.Sound) window.Sound.setEnabled(soundEnabled);

      const label = document.querySelector('label[for="soundToggle"]');
      if (!label) return;

      if (soundEnabled){
        label.textContent = "üîä Signalton aktiviert";
        if (window.Sound) window.Sound.play(); // kurzer Best√§tigungston
      } else {
        label.textContent = "üîá Signalton deaktiviert";
      }
    }

    function scrollToNext(){
      if (!Array.isArray(schedule) || !schedule.length) return;
      const { nextIndex } = findCurrentAndNext();
      if (nextIndex !== -1){
        const el = document.getElementById(`item-${nextIndex}`);
        if (el) el.scrollIntoView({ behavior:"smooth", block:"center" });
      }
    }

    function toggleTheme(){
      document.body.classList.toggle("medical");
      const isMedical = document.body.classList.contains("medical");
      localStorage.setItem("theme", isMedical ? "medical" : "default");
    }

    function loadTheme(){
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "medical") document.body.classList.add("medical");
    }

    function loadSoundPreference(){
      const savedSound = localStorage.getItem("soundEnabled");
      if (savedSound !== null){
        soundEnabled = savedSound === "true";
        const t = document.getElementById("soundToggle");
        if (t) t.checked = soundEnabled;

        if (window.Sound) window.Sound.setEnabled(soundEnabled);

        const label = document.querySelector('label[for="soundToggle"]');
        if (label) label.textContent = soundEnabled ? "üîä Signalton aktiviert" : "üîá Signalton deaktiviert";
      } else {
        if (window.Sound) window.Sound.setEnabled(true);
      }
    }

    // Scroll-Detektor
    let isScrolling = false;
    let scrollTimer = null;
    window.addEventListener("scroll", () => {
      isScrolling = true;
      if (scrollTimer) clearTimeout(scrollTimer);
      scrollTimer = setTimeout(() => { isScrolling = false; }, 180);
    }, { passive:true });

    // =========================================================
    // 5) Start
    // =========================================================
    async function start(){
      loadTheme();
      loadSoundPreference();
      loadOffset();
      initDaySwitch();
      updateTime();
      updateCalorieSummary();

      if (("Notification" in window) && Notification.permission === "default"){
        const a = document.getElementById("notificationAlert");
        if (a) a.classList.add("show");
      }

      try{
        await loadPlanForCurrentSelection();
      } catch(e){
        showPlanError(e);
      }

      setInterval(async () => {
        updateTime();

        // Auto-Reset pr√ºfen (manueller Tag l√§uft nach 1 Minute aus)
        const saved = (localStorage.getItem(DAY_OVERRIDE_KEY) || "auto").toLowerCase();
        const until = parseInt(localStorage.getItem(MANUAL_UNTIL_KEY) || "0", 10);

        if (saved !== "auto" && until > 0 && Date.now() >= until) {
          localStorage.setItem(DAY_OVERRIDE_KEY, "auto");
          localStorage.removeItem(MANUAL_UNTIL_KEY);

          // Buttons aktiv setzen
          const wrap = document.getElementById("daySwitch");
          if (wrap) {
            Array.from(wrap.querySelectorAll(".day-btn")).forEach(b => b.classList.remove("active"));
            const autoBtn = wrap.querySelector(`.day-btn[data-day="auto"]`);
            if (autoBtn) autoBtn.classList.add("active");
          }

          try{
            await loadPlanForCurrentSelection();
          } catch(e){
            showPlanError(e);
          }
        }

        updateNextItem();
        updateCalorieSummary();
        checkForNotifications();
        if (!isScrolling) updateTimeline();
      }, 10000);
    }

    start();
  </script>
</body>
</html>
